name: Release

on:
  # Trigger on published releases (tags like v1.x.x)
  release:
    types: [published]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag (e.g., dev, beta, 1.0.0)'
        required: true
        default: 'dev'
      skip_version_sync:
        description: 'Skip version sync step'
        required: false
        type: boolean
        default: true

env:
  DOCKER_IMAGE: grimothy/bandmate

jobs:
  # --- Job 1: Sync package.json versions to match the release tag ---
  sync-versions:
    name: Sync Package Versions
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Determine version from release tag
        id: version
        run: |
          # Strip v/V prefix from tag
          VERSION=${GITHUB_REF_NAME#v}
          VERSION=${VERSION#V}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Syncing package.json files to version: $VERSION"

      - name: Update package.json files
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          cd backend
          npm version $VERSION --no-git-tag-version --allow-same-version
          cd ..

          cd frontend
          npm version $VERSION --no-git-tag-version --allow-same-version
          cd ..

          echo "Updated package.json files to version $VERSION"

      - name: Commit and push if changed
        run: |
          if git diff --quiet; then
            echo "No changes needed - versions already in sync"
          else
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add backend/package.json backend/package-lock.json frontend/package.json frontend/package-lock.json
            git commit -m "chore: sync package.json versions to ${{ steps.version.outputs.version }}"
            git push origin main
          fi

  # --- Job 2: Build and push Docker image ---
  docker-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    needs: [sync-versions]
    # Run after sync-versions succeeds, or skip the dependency for manual runs
    if: always() && (needs.sync-versions.result == 'success' || needs.sync-versions.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Determine version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION=${GITHUB_REF_NAME#v}
          else
            VERSION=${{ github.event.inputs.tag }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building with tag: $VERSION"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Production release: tag with version AND latest
      - name: Build and push (release)
        if: github.event_name == 'release'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Manual push: only tag with provided name (no latest)
      - name: Build and push (manual)
        if: github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Trigger BandMate_site rebuild on production releases
      - name: Trigger site rebuild
        if: github.event_name == 'release'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.SITE_REPO_TOKEN }}
          repository: Grimothy/BandMate_site
          event-type: bandmate-released
          client-payload: '{"version": "${{ steps.version.outputs.version }}", "ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}'
